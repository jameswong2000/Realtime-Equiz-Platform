define(["jquery","core/log","core/templates"],function(c,p,l){function d(){u.votes=[],c.each(u.options,function(e){u.votes[e]=0})}function t(){u.listeningToClicks||(c(".livepoll-votebtn").on("click",function(){var o={option:c(this).data("option")},l=u.database.ref("polls/"+u.pollKey+"/votes/"+u.userKey);l.once("value").then(function(e){e.val()&&e.val().option===o.option?l.remove():l.set(o)})}),u.listeningToClicks=!0)}function n(){var l=[];c.each(u.resultHandlers,function(e,o){o=o.update(u.options,u.votes);l.push(o)}),c.when.apply(c,l).done(function(){p.debug("livepoll UI has been updated.")})}function i(){u.database.ref("polls/"+u.pollKey+"/votes").once("value").then(function(e){e=e.val();d(),c(".livepoll-votebtn").addClass("btn-primary").removeClass("btn-success"),c.each(e,function(e,o){u.votes[o.option]++,e===u.userKey&&c('.livepoll-votebtn[data-option="'+o.option+'"]').addClass("btn-success").removeClass("btn-primary")}),u.showPollingResult&&n()})}function o(){u.database.ref("polls/"+u.pollKey+"/controls").once("value").then(function(e){var o,e=e.val();u.closeVoting=!!e.closeVoting,u.showPollingResult=!!e.showPollingResult,u.higlightAnswer=!!e.higlightAnswer,c("#livepoll_closevoting").prop("checked",u.closeVoting),c("#livepoll_showpollingresult").prop("checked",u.showPollingResult),c("#livepoll_highlightanswer").prop("checked",u.higlightAnswer),c(".livepoll-votebtn").toggleClass("disabled",u.closeVoting),u.closeVoting?(u.listeningToClicks&&(c(".livepoll-votebtn").off("click"),u.listeningToClicks=!1),0===c(".livepoll-closed-voting-msg > .alert").length&&l.render("mod_livepoll/voting_closed",{}).then(function(e,o){l.appendNodeContents(".livepoll-closed-voting-msg",e,o),c(".livepoll-closed-voting-msg > .alert").alert().removeClass("hide").addClass("show")}),s&&(clearInterval(s),s=null,c(".time-limit-countdown").html(v))):(t(),0<c(".livepoll-closed-voting-msg > .alert").length&&c(".livepoll-closed-voting-msg > .alert").alert("close"),(o=v)<=0||(s=s||setInterval(function(){c(".time-limit-countdown").html(o--),o<0&&(clearInterval(s),s=null,c(".time-limit-countdown").html("Time is UP!!!"),c("#livepoll_closevoting").prop("checked",!0),c("#livepoll_closevoting").trigger("change"))},1e3))),u.showPollingResult?i():(d(),n()),c(".livepoll-votebtn").removeClass("livepoll-answer-animation"),c(".mod-livepoll-text-result").removeClass("livepoll-answer-animation"),u.higlightAnswer&&(c('.livepoll-votebtn[data-option="'+u.correctOption+'"]').addClass("livepoll-answer-animation"),c(".mod-livepoll-text-result:has(#vote-count-"+u.correctOption+")").addClass("livepoll-answer-animation"))})}var s,u=this,v=0,h=function(){c("#livepoll_closevoting").on("change",function(){var e=this.checked;u.database.ref("polls/"+u.pollKey+"/controls/closeVoting").set(e)}),c("#livepoll_showpollingresult").on("change",function(){var e=this.checked;u.database.ref("polls/"+u.pollKey+"/controls/showPollingResult").set(e)}),c("#livepoll_highlightanswer").on("change",function(){var e=this.checked;u.database.ref("polls/"+u.pollKey+"/controls/higlightAnswer").set(e)}),u.closeVoting||(c(".livepoll-votebtn").removeClass("disabled"),t())},g=function(){var e=u.database.ref("polls/"+u.pollKey+"/votes");e.on("child_added",i),e.on("child_changed",i),e.on("child_removed",i);e=u.database.ref("polls/"+u.pollKey+"/controls");e.on("child_added",o),e.on("child_changed",o),e.on("child_removed",o),u.showpollingresult&&n()},f=function(){var e=c.Deferred(),t=[];u.resultHandlers=[];var i=["green","bold","shadowy"];return c.each(u.resultsToRender,function(e,o){var l=c.Deferred();require(["mod_livepoll/"+o+"-result-lazy"],function(e){var t,n;"text"===o?(t=new e,n=[],c.each(i,function(e,o){var l=c.Deferred();n.push(l.promise()),require(["mod_livepoll/"+o+"-text-result-lazy"],function(e){t=new e(t),l.resolve()})}),c.when.apply(c,n).done(function(){u.resultHandlers.push(t),l.resolve()})):(u.resultHandlers.push(new e),l.resolve())}),t.push(l.promise())}),c.when.apply(c,t).done(function(){e.resolve()}),e.promise()};return{init:function(e,o,l,t,n,i,s,a,r){u.apiKey=e,u.authDomain=o,u.databaseURL=l,u.projectID=t,u.options=s,u.correctOption=a,u.pollKey=n,u.userKey=i,u.resultsToRender=r,u.closeVoting=!1,u.higlightAnswer=!1,u.listeningToClicks=!1,d(),c(document).ready(function(){var e;void 0!==firebase?(u.firebase=firebase,e={apiKey:u.apiKey,authDomain:u.authDomain,databaseURL:u.databaseURL,projectId:u.projectID},u.firebase.initializeApp(e),u.database=u.firebase.database(),u.auth=u.firebase.auth(),u.auth.signInAnonymously().catch(function(e){var o=e.code,e=e.message;p.error("Could not authenticate into firebase using anonymous setup."),p.error(o),p.error(e)}),u.auth.onAuthStateChanged(function(e){e?(p.debug("User has signed in to firebase."),u.fbuser=e,f().done(function(){g(),h()})):p.debug("User has signed out from firebase.")}),0<c(".livepoll-switch").length&&(u.database.ref("polls/"+u.pollKey+"/controls/closeVoting").set(!0),c("#livepoll_closevoting").prop("checked",!0)),v=parseInt(c(".time-limit-countdown").html())):p.error("Firebase not found. Live poll will not work.")})}}});